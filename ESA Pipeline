ESA PIPELINE:
-----------------------------------------------------------------------

ESA pipeline is processed in 3 phases that are:
1)Receipt
2)work queue
3)Delivery

RECEIPT:-
===========================

As we know that between sender SMTP and receiver SMTP ESA is there. Before connection and start of communication between them firstly 
ESA verifies the connection request is genuine or not.

STEP 1: Sender SMTP sends the connection request to receiver SMTP.
----------

STEP 2: What action does the HAT(Host access table) indicate for the SMTP connection? 
-----------
    
HAT compares the source IP address in the HAT table. If the IP address is not found then it will reject the action and 
connection is     dropped otherwise it will check for some of its config policies and if the mail satisfying all of its policy then action is accepted and     proceed for the further steps otherwise the action is TCPREFUSE and it refuse the connection.

STEP 3: "Add received header" listener property is processed.
------------
    
Then the received header is added (you can config it if you don't want to add) and listener property (it the global properties that 
apply to all listener e.g: you can specify the IP interface and port to use for a listener whether it is public or private .
you can config listener by using configlistener command)is processed.

STEP 4: "Add Default Domain" listener property is processed
-----------

After adding the received header default domain is added it means you can config a listener to automatically append default domain to 
sender address that do not contain fully qualified domain name. And then listener properties is processed.

STEP 5: (Outgoing )Envelope sender address is tagged if the Cisco Bounce verification is enabled.
-----------

Outgoing mail is tagged with a special key and so if that mail is sent back as a bounce, the tag is recognized and the mail is delivered.

STEP 6: (Incoming ) Envelope recipient address is rewritten according to domain map table.
------------

For each listener you configure you can construct a domain map table which rewrites the envelope recipient, for each recipient in a 
message that matches a domain in the domain map table.
e.g; saloni2.jain@aricent.com---> saloni2.jain@altran.com 

STEP 7: (public ) Does the recipient access table (RAT) indicate to accept to the alias tables.
------------

After getting rewritten it moves to the RAT.
RAT (Recipient access table ) it is for inbound email only, it allows you to specify a list of all local domains for which the 
appliance will accept mail.

STEP 8: Envelope recipient address is rewritten according to the alias table
-----------


STEP 9: Do the LDAP acceptance queries indicate this is a valid recipient?
----------------

LDAP (Lightweight directory access protocol) it checks for the valid recipients with the help of DHAP (directory harvest attack 
prevention).
DHAP keep the track of the number of invalid recipient address from a given sender.
DHA is a technique that is used by spammers in order to locate valid email addresses. There are two main techniques that are used in 
order to generate the addresses that DHA targets:

The spammer creates a list of all possible combinations of letters and numbers, and then appends the domain name.

The spammer uses a standard dictionary attack with the creation of a list that combines common first names, surnames, and initials.

The DHAP is a supported feature on the Cisco Content Security Appliances that can be enabled when Lightweight Directory Access Protocol 
(LDAP) acceptance validation is used. The DHAP feature keeps track of the number of invalid recipient addresses from a given sender.

Once a sender crosses an administrator-defined threshold, the sender is deemed to be untrusted, and mail from that sender is blocked 
with no Network Design Requirement (NDR) or error code generation. You can configure the threshold based upon the reputation of the
sender. For example, untrusted or suspicious senders can have a low DHAP threshold, and trusted or reputable senders can have a high
DHAP threshold.

If the recipient is not valid then reject the request and connection is dropped. 

STEP 10: Does smtp call -ahead recipient validation indicate this is a valid recipient?
--------------

The SMTP call-ahead recipient validation feature queries an external SMTP server before accepting incoming

mail for a recipient. Use this feature to validate recipients when you cannot use LDAP Accept or the Recipient

Access Table (RAT). For example, suppose you host mail for many mailboxes, each using a separate domain,

and your LDAP infrastructure does not allow you to query the LDAP server to validate each recipient. In this

case, the Email Security appliance can query the SMTP server and validate the recipient before continuing

the SMTP conversation.

You can use SMTP call-ahead recipient validation in order to reduce processing on messages for invalid

recipients. Typically, a message for an invalid recipient progresses through the work queue before it can be

dropped. Instead, an invalid message can be dropped or bounced during the incoming/receiving part of the

email pipeline without requiring additional processing.

If the mail request is valid then it proceed to further connection or it reject the connection and connection is dropped.

STEP 11: (Incoming ) Is this a forged message according to SPF or SIDE email authentication?
-------------

SPF (sender policy framework) prevents spammer from sending message on behalf of your domain with DMARC.
 DMARC (Domain-based Message Authentication Reporting and Conformance) is an email validation system designed to protect your company’s 
 email domain from being used for email spoofing, phishing scams and other cybercrimes. 

If it is forged message according to SPF then connection is dropped else connection is accepted.

STEP 12: Accept connection and process message in work queue.
-------------

WORK QUEUE
=========================

After establishing the connection the message moves to the working queue.

STEP 1: Do the LDAP acceptance queries indicate this is valid recipient?
-------------

Here the system accept the message and perform the LDAP acceptance validation within the smtp conversation or the work queue . 
If the recipient is not found in LDAP directory then message is bounce or drop.

STEP 2: Envelope sender and some email header are rewritten based on the table or LDAP query (masquerading).
-----------

Masquerading is a feature that rewrites the envelope sender and the To:, From:, and / or CC: header on email processed by a private or 
public listener according to table you construct.

Masquerading is the Linux-specific form of NAT (network address translation). It can be used to connect a small LAN (where hosts use IP 
addresses from the private range with the Internet (where official IP addresses are used). For the LAN hosts to be able to connect to 
the Internet, their private addresses are translated to an official one. This is done on the router, which acts as the gateway between 
the LAN and the Internet. The underlying principle is a simple one: The router has more than one network interface, typically a network
card and a separate interface connecting with the Internet. While the latter links the router with the outside world, one or several 
others link it with the LAN hosts. With these hosts in the local network connected to the network card (such as eth0) of the router, 
they can send any packets not destined for the local network to their default gateway or router.

STEP 3: Messages are created for each alias target according to LDAP routing queries.
----------

According to alias queries, messages are created for each alias target you can config your appliance to route message to the appropriate
address and or mail host based upon the information available in the LDAP directories on your network.

STEP 4: Message filter is applied to message and action is taken. Based on the message filter policy action like bounce, drop, message

----------------
 delivered, encrypt and deliver.

Message filter allows you to create special rules describing how to handle messages and attachments as they are received. 
Its rules based on the message or attachments content, info about network, message envelop, the message header, or message body.
Filter actions allow messages to be dropped, bounced, archived, quarantined, blind carbon copied, or altered. 
A message filter specifies that a certain kind of email message should be given special treatment. Cisco message filters also allow you 
to enforce corporate email policy by scanning the content of messages forwards you specify.

STEP 5: All other action is performed.
--------------

After passing through the message filter multi-recipient are splintered in this phase prior to the email security manager. Splintering
messages refers to creating a splinter copy of email while a single recipient while processing via email security manager.

STEP 6: Is the sender address in the end user safe list or blocklist database.
------------
End-user safe list and block list are created by the end users and stored in the database that is checked prior ti the anti-spam
scanning. Each end user can identify the domain, subdomain or email address that they wish to always treat as spam or never treat as 
spam. If a sender address is a part of an end user safe list, anti-spam scanning(STEP 7) is skipped, and if the sender address is listed
in the block list the message may be quarantine or dropped depending on the administrator setting.

STEP 7: Is the message identified as spam?(Maybe skipped due to configuration) If yes then the action is a quarantine, if no ten go for 
further steps
-----------

Antispam scanning engine, it provides the score to each message. The higher the score, the greater the likelihood that the message is 
spam.
Based on the score Message is differentiated in 3 parts;
1)Not spam
2)suspected spam
3) positively identified spam 

Cisco appliances offers 2 anti-spam solutions 
1) IPAS (Iron port anti spam filtering )engine
2)Cisco intelligent multi scan filtering

You can license and enable both but you can only use one in a particular mail policy.

1) IPAS: IPAS addresses a full range of known threats including spam, phishing, zombie attack, as well as hard-to-detect low volume, 
short-lived email threats such as “419” scams.

To identify these threats, IronPort Anti-Spam examines the full context of a message-its content, methods of message construction,the
reputation of the sender, the reputation of websites advertised in the message, and more. IronPort Anti-Spam combines the power of email
and web reputation data, leveraging the full power of the world's largest email and web traffic monitoring network—Sender Base—to detect
new attacks as soon as they begin. 

2) CIMS: Cisco Intelligent Multi - Scan incorporates multiple anti-spam scanning engines,including Cisco Anti-Spam, to provide a 
multi-layer anti-spam solution. 
When processed by Cisco Intelligent Multi-Scan:
 • A message is first scanned by third-party anti-spam engines.
 • Cisco Intelligent Multi-Scan then passes the message and the verdicts of the third-party engines to the Cisco Anti-Spam, which 
   assumes responsibility for the final verdict.
 • After Cisco Anti - Spam performs its scan, it returns a combined multi-scan score to AsyncOS.
 • Combining the benefits of the third-party scanning engines and Cisco Anti-Spam results in more caught spam while maintaining Cisco 
 Anti-Spam’s low false positive rate.


STEP 8: Is the message identified to have a virus? (Maybe skipped due to configuration) action is either yes or quarantine based on the 
policy.
--------------

The Cisco appliance includes integrated virus scanning engines from third-party companies Sophos and McAfee.

viruses are detected depends on their types. During the scanning process, the engine analyses each file identifies the type and then 
applies the relevant techniques.

Certain types of techniques are:-

Pattern Matching:- In the technique of pattern matching, the engine knows the particular sequence of code and is looking for an exact 
match that will identify the code as a virus. More often, the engine is looking for sequences of code that are similar, but not 
necessarily identical, to the known sequences of virus code.

Heuristic (learn from themselves):- A technique using general rather than specific rules. The technique enables a single description to
be created that will catch several variants of one virus.

Emulation:-Emulation is a technique applied by the virus engine to polymorphic viruses.

SOPHOS:- When the virus is found the Sophos anti-virus can disinfect the file. It usually repairs the file in which the virus has been 
found, after which the file can be used without risk. Precise action is taken depends on the virus.

Sophos exchange viruses with other trusted anti-virus companies every month. In addition, every month customers send thousands of 
suspect files directly to Sophos, about 30% of which turn out to be viruses. Each sample undergoes rigorous analysis in the highly 
secure virus labs to determine whether or not it is a virus. For each newly discovered virus or group of viruses, Sophos creates a 
description.


McAfee:- McAfee scanning engine :
    • Scans files by pattern-matching virus signatures with data from your files.

      McAfee uses anti-virus definition(DAT) files with the scanning engine to detect particular viruses, types of viruses, or 
      other       potentially unwanted software. Together, they can detect a simple virus by starting from a known place in a file, 
      then searching       for a virus signature. Often, they must search only a small part of a file to determine that the file is 
      free from viruses.


     • Decrypts and runs virus code in an emulated environment. 

      Complex viruses avoid detection with signature scanning by using two popular techniques: 
        • Encryption:- The data inside the virus is encrypted so that anti-virus scanners cannot see the messages or computer code               of the virus. When the virus is activated, it converts itself into a working version, then executes.
        • Polymorphism:- This process is similar to encryption, except that when the virus replicates itself, it changes its appearance.

    To counteract such viruses, the engine uses a technique called emulation. If the engine suspects that a file contains such a virus, 
    the engine creates an artificial environment in which the virus can run harmlessly until it has decoded itself and its true form
    becomes visible. The engine can then identify the virus by scanning for a virus signature, as usual.


    • Applies heuristic techniques to recognize new viruses.
      
      Using only the virus signature, the engine cannot detect a new virus because its signature is not yet known. Therefore the engine       can use the additional technique known as heuristic technique.
      Programs, documents or email messages that carry a virus often have distinctive features. They might attempt an unprompted
      modification of files, invoke mail clients, or use other means to replicate themselves. The engine analyzes the program code to 
      detect these kinds of computer instructions. The engine also searches for legitimate non - virus-like behavior, such as prompting
      the user before taking action and thereby avoids raising false alarms. By using these techniques, the engine can detect many   
      new viruses.
    • Removes infectious code from files.

The disadvantage of Sophos:-

When a virus has been detected, Sophos Anti-Virus can repair(disinfect) the file. Sophos Anti Virus can usually repair any file in 
which a virus has been found, after which the file can be used without risk. The precise action taken depends on the virus. There can 
be limitations when it comes to disinfecting because it is not always possible to return a file to its original state. Some viruses 
overwrite part of the executable program which cannot be reinstated. In this instance, you define how to handle messages with attachments
that could not be repaired.

STEP 9:- Does a message attachment contain a threat? (Behavior depends on configuration) if yes then action is drop, if unknown then action 
--------       
      is quarantine . No , yes and infected attachment is dropped ,OR unknown appliance is not configured to quarantine unknown files.

STEP 10:- Is the message identified to have a gray mail?(May be skipped due to configuration) If yes then action may be drop or bounce  
-----------------------
      depends on the policy. No, or yes the action is deliver.
   
You can configure the appliance to detect gray mail messages and perform secure unsubscribe on behalf of the end user. Available actions are similar to those for anti-virus scanning. 

GRAYMAIL:- Gray mail messages are messages that do not fit the definition of spam, for example, newsletters, mailing list subscriptions, social media notifications, and so on. These messages were of use at some point in time, but have subsequently diminished in value to the point where the end user no longer wants to receive them. 
The difference between gray mail and spam is that the end user intentionally provided an email address at some point (for example, the 
end user subscribed to a newsletter on an e-commerce website or provided contact details to an organization during a conference) as 
opposed to spam, messages that the end user did not signup for. 

STEP 11:- Content filters are applied and the action is taken(Maybe skipped due toconfiguration) Based on the policy action like deliver,
-----------
encrypt, encrypt and deliver, drop,bounce, and action is to skip outbreak filters are performed (directly goes to step 13)

Content filter checks each and every content of the message eg message language it body its header footer etc.
The Email Security appliance has a separate “master list” of content filters for each type of message. The master list also determines 
in which order the appliance runs the content filters. However, each individual mail policy determines which particular filters will be
executed when a message matches the policy. 

Content filters scan messages on a per-user (sender or recipient) basis.
 Content filters have the following components:
 • conditions that determine when the appliance uses a content filter to scan a message(optional)
 • actions that the appliance takes on a message(required)
 • action variables that the appliance can add to a message when modifying it (optional).

STEP 12:- Do the outbreak filter indicate an outbreak is present? If yes then the message is quarantine or if no then the message goes 
---------------
to the next step.

Outbreak Filters protect your network from large-scale virus outbreaks and smaller, non-viral attacks, such as phishing scam sand 
malware distribution, as they occur.
Outbreak Filters analyzes a message’s content and searches for URL links to detect this type of non-viral attack. Outbreak Filter
scan rewrites URLs to redirect traffic to potentially harmful websites through a web security proxy, which either warns users that 
the website they are attempting to access may be malicious or blocks the website completely. 

STEP 13:- If the message is not spam, virus, and threat positive, add graymail safe unsubscribe banner (may be skipped due to 
-------------
configuration ) 

STEP 14:-(outbound ) Does the DLP Engine detect a DLP violation? Depends on the policy the action quarantined, drop or action is
------------
delivered.

DELIVERY:-
===================================================================

STEP 1:- Start SMTP client converstaion

STEP 2:- (Outgoing)Mesasge is encrypted if applicable

STEP 3:- Message is sent over a particular IP inteface defined bty the virtual gateway.

STEP 4:-The total maximum number of outbound connection is enforced , and the default deliver inteface is enforced.

STEP 5:- "Recived" header is added to the message 

STEP 6:- Do the configured domain- based limits such as such as maximum number of connection recipents, indicate to drop or 
bounce the message? If yes then based on the policy the message is droped or bounce and if NO then it continue futher.

STEP 7:- Message is routed to specifc mail exchange host based on domain without rewriting envelope recipent.

STEP 8:- Specific receipient are dopped as configured in the Global Unsuscribe list.

STEP 9:- (Outgoing ) DOmain KEy or DKIM signature header is added to the message.

STEP 10:- Is the message undeliverable based on configured Bounce Profile? If YES then based on the policy the mesaage can be bounced 
or dropped, and if NO then the message is delivered. 
